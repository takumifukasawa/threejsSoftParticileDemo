<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>threejsSoftParticleDemo</title>
  <style type="text/css">
    .wrapper {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
    
    .wrapper canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: block;
    }
  </style>
</head>
<body>
  <div class="wrapper js-wrapper">
    <canvas class="js-canvas"></canvas>
  </div>

  <script id="particle-vertex" type="v-script">
    attribute vec3 position;
    attribute vec2 uv;
    uniform mat4 projectionMatrix;
    uniform mat4 modelViewMatrix;
    varying vec2 vUv;
    varying vec4 vViewPosition;
    varying vec4 vPosition;
    void main() {
      vUv = uv;
      vec4 p = projectionMatrix * modelViewMatrix * vec4(position, 1.);
      vViewPosition = modelViewMatrix * vec4(position, 1.);
      vPosition = p;
      gl_Position = p;
    }
  </script>

  <script id="particle-fragment" type="f-script">
    precision highp float;

    #include <packing>

    varying vec2 vUv;
    varying vec4 vViewPosition;
    varying vec4 vPosition;
    uniform sampler2D tDepth;
    uniform float cameraNear;
    uniform float cameraFar;
    uniform float depthFade;
    uniform vec2 resolution;

    float readDepth(sampler2D depthSampler, vec2 coord) {
      float fragCoordZ = texture2D(depthSampler, coord).x;
      float viewZ = perspectiveDepthToViewZ(fragCoordZ, cameraNear, cameraFar);
      return viewZToOrthographicDepth(viewZ, cameraNear, cameraFar);
    }

    void main() {
      vec2 screenCoord = vec2(
        gl_FragCoord.x / resolution.x,
        gl_FragCoord.y / resolution.y
      );
      float sceneDepth = readDepth(tDepth, screenCoord);
      gl_FragColor = vec4(vec3(sceneDepth), 1.);

      float viewZ = vViewPosition.z;
      float z = viewZToOrthographicDepth(viewZ, cameraNear, cameraFar);
      float currentDepth = z;

      float fade = clamp(abs(currentDepth - sceneDepth) / max(depthFade, .0001), 0., 1.);

      gl_FragColor = vec4(vec3(1.), fade);
    }
  </script>

  <script id="postprocess-vertex" type="v-script">
    attribute vec3 position;
    attribute vec2 uv;
    uniform mat4 projectionMatrix;
    uniform mat4 modelViewMatrix;
    varying vec2 vUv;
    void main() {
      vUv = uv;
      gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.);
    }
  </script>

  <script id="postprocess-fragment" type="f-script">
    precision highp float;

    #include <packing>

    varying vec2 vUv;
    uniform sampler2D tDiffuse;
    uniform sampler2D tDepth;
    uniform float cameraNear;
    uniform float cameraFar;

    // includes in threejs packed codes
    // float viewZToOrthographicDepth( const in float viewZ, const in float near, const in float far ) {
    //   return ( viewZ + near ) / ( near - far );
    // }
    // float orthographicDepthToViewZ( const in float linearClipZ, const in float near, const in float far ) {
    //   return linearClipZ * ( near - far ) - near;
    // }
    // float viewZToPerspectiveDepth( const in float viewZ, const in float near, const in float far ) {
    //   return (( near + viewZ ) * far ) / (( far - near ) * viewZ );
    // }
    // float perspectiveDepthToViewZ( const in float invClipZ, const in float near, const in float far ) {
    //   return ( near * far ) / ( ( far - near ) * invClipZ - far );
    // }

    float readDepth(sampler2D depthSampler, vec2 coord) {
      float fragCoordZ = texture2D(depthSampler, coord).x;
      float viewZ = perspectiveDepthToViewZ(fragCoordZ, cameraNear, cameraFar);
      return viewZToOrthographicDepth(viewZ, cameraNear, cameraFar);
    }

    void main() {
      vec4 diffuseColor = texture2D(tDiffuse, vUv);
      float depth = readDepth(tDepth, vUv);
      gl_FragColor = vec4(vec3(1. - depth), 1.);
    }
  </script>
  <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/three.js/r123/three.min.js"></script>
  <script type="text/javascript" src="//threejs.org/examples/js/controls/OrbitControls.js"></script>
  <script type="text/javascript" src="//cdn.jsdelivr.net/npm/tweakpane@1.5.7/dist/tweakpane.min.js"></script>
  <script type="text/javascript" src="/script.js"></script>
</body>
</html>